  deploy-frontend:
    docker:
      - image: circleci/node:13.8.0
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install AWS CLI dependencies
          working_directory: /tmp
          command: |
            sudo apt-get update && sudo apt-get install -yy less
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
      - run:
          name: Get backend url
          working_directory: ./frontend
          command: |
            export API_URL=$(curl -H "token: 4292407b-7685-40a1-a45a-26deee1d80b7" --request GET https://api.memstash.io/values/BACKEND_URL)
            echo "${API_URL}"
            npm run build

      - run:
          name: Deploy frontend objects
          working_directory: ./frontend
          command: |
             aws s3 cp ./dist "s3://udapeople-${CIRCLE_WORKFLOW_ID:0:7}" --recursive
      - persist_to_workspace:
          root: .
          paths:
            - frontend/dist
#      - destroy_environment:
#          id: ${CIRCLE_WORKFLOW_ID:0:7}
#          when: on_fail
#      - revert_migrations:
#          id: ${CIRCLE_WORKFLOW_ID:0:7}
#          when: on_fail




smoke-test:
    docker:
      - image: python:3.9.0-alpine 
    steps:
      - checkout
      - run:
          name: Install dependencies
          working_directory: /tmp
          command: |
            apk add --update curl nodejs npm
            pip install awscli
      - run:
          name: Backend smoke test.
          working_directory: ./backend
          command: |
            export BACKEND_URL=$(curl -H "token: 4292407b-7685-40a1-a45a-26deee1d80b7" --request GET https://api.memstash.io/values/BACKEND_URL)
            curl "$BACKEND_URL/api/status"
      - run:
          name: Frontend smoke test.
          command: |
            URL="https://s3.us-west-2.amazonaws.com/udapeople-${CIRCLE_WORKFLOW_ID:0:7}/index.html"
            curl -s ${URL} | grep -q "Welcome"
#test smoke again



- deploy-frontend:
          requires:
            - run-migrations
      - smoke-test:
          requires:
            - deploy-backend
            - deploy-frontend